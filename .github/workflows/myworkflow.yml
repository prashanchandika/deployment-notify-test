name: Test Workflow
on:
  push:
    branches:
      - main

permissions:
  contents: read

env:
  ENV: "test"

jobs:
  job1:
    name: Job1
    runs-on: ubuntu-latest

    steps:
      - name: Start Deployment Timer
        if: always()
        id: start-time
        run: |
          echo "START_TIME=$(date +%s)" >> $GITHUB_ENV
      - name: Test Step
        run: |
          echo "sleeping for 5"
          sleep 10
  job2:
    name: Job2
    runs-on: ubuntu-latest

    steps:
      - name: Test Step
        run: |
          echo "sleeping for 5"
          sleep 10
          exit 1
          

        
  notify:
    runs-on: ubuntu-latest
    needs: [job1]  # Monitors all jobs
    if: always()  # Runs even if jobs fail
    steps:
      - name: Determine Failed Jobs
        run: |
          FAILED_JOBS=""
          
          for job in job1 job2; do
            if [[ "${{ job.result }}" == "failure" ]]; then
              FAILED_JOBS+="❌ $job failed\n"
            fi
          done

          if [[ -z "$FAILED_JOBS" ]]; then
            echo "WORKFLOW_STATUS=✅ All jobs succeeded!" >> $GITHUB_ENV
          else
            echo -e "$FAILED_JOBS" > failed_jobs.txt
            echo "WORKFLOW_STATUS=❌ Some jobs failed!" >> $GITHUB_ENV
          fi

      - name: Send Notification
        run: |
          echo ${{ env.WORKFLOW_STATUS }}
